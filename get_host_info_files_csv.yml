---
- hosts:
  - ubuntu-test-srv-1
  - ubuntu-test-srv-2
  - ubuntu-test-srv-3
  tasks:
    - name: Fetch the file from remote node to buffer
      fetch:
        src: /tmp/{{ inventory_hostname }}_inventory_information.csv
        dest: /tmp/awx-host-info/{{ inventory_hostname }}_inventory_information.csv
        flat: yes

    - name: Copy the file from buffer to remote node
      delegate_to: andy-awxnode-test
      copy:
        src: /tmp/awx-host-info/{{ inventory_hostname }}_inventory_information.csv
        dest: /tmp/awx-host-info/

    - name: Create the combined file if it does not exist
      delegate_to: andy-awxnode-test
      shell: "test -e /tmp/combined-host-info.csv || head -1 /tmp/awx-host-info/{{ hostvars[first_inventory_file].inventory_hostname }} > /tmp/combined-host-info.csv"
      vars:
        first_inventory_file: "{{ (first_inventory_file is defined) ? first_inventory_file : inventory_hostname }}"

    - name: Concatenate the files into one file
      delegate_to: andy-awxnode-test
      shell: "tail -n +2 /tmp/awx-host-info/{{ inventory_hostname }}_inventory_information.csv >> /tmp/combined-host-info.csv"
